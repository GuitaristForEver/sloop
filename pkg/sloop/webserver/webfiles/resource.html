<!--
Copyright (c) 2019, salesforce.com, inc.
All rights reserved.
SPDX-License-Identifier: BSD-3-Clause
For full license text, see LICENSE.txt file in the repo root or https://opensource.org/licenses/BSD-3-Clause
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='shortcut icon' type='image/x-icon' href='webfiles/favicon.ico'/>
    <link rel="stylesheet" type="text/css" href="webfiles/sloop.css">
    <link rel="stylesheet" type="text/css" href="webfiles/resource.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css"  />
    <link rel="stylesheet" type="text/css" href="https://cemerick.github.io/jsdifflib/diffview.css"  />

    <title>Resource {{.Kind}}/{{.Namespace}}/{{.Name}}</title>

    <!-- This list of scripts needs to also live in index.html -->
    <script src="https://unpkg.com/axios/dist/axios.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js" type="text/javascript"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js" type="text/javascript"></script>
    <script src="https://cemerick.github.io/jsdifflib/diffview.js" type="text/javascript" ></script>
    <script src="https://cemerick.github.io/jsdifflib/difflib.js" type="text/javascript" ></script>

</head>
<body>
<div id="resource_body" style="padding:10px">
<div id="resource_container">
    <div class="resource-header">
        <button id='close' onclick='this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode); return false;'>×</button>
        <h2>📋 Resource Details</h2>
        <div class="resource-meta">
            <div class="resource-meta-item">
                <div class="resource-meta-label">Name</div>
                <div class="resource-meta-value">{{.Name}}</div>
            </div>
            <div class="resource-meta-item">
                <div class="resource-meta-label">Namespace</div>
                <div class="resource-meta-value">{{.Namespace}}</div>
            </div>
            <div class="resource-meta-item">
                <div class="resource-meta-label">Kind</div>
                <div class="resource-meta-value">{{.Kind}}</div>
            </div>
        </div>
    </div>

    {{if ne (len .Links) 0 }}
    <div class="resource-section">
        <h2><span class="section-icon">🔗</span> External Links</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            {{range .Links}}
            <a href="{{.Url}}" target="_blank" style="background: var(--accent-blue); color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 13px; transition: var(--transition);">{{.Text}}</a>
            {{end}}
        </div>
        <div style="margin-top: 12px;">
            <a href="{{.SelfUrl}}" target="_blank" style="color: var(--accent-blue); text-decoration: none; font-size: 13px;">🔗 Open in New Tab</a>
        </div>
    </div>
    {{end}}

    <div id="resource_payload" class="resource-section">
        <h2><span class="section-icon">📊</span> Payload History</h2>
        <div style="background: var(--accent-bg); padding: 12px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
            <strong>Time Range:</strong> {{.ClickTime}} ± {{.PlusMinusTime}}
        </div>
        <table id="resource_event_table">
            <tr v-if="sortedResPayloads.length">
                <th @click="sort('leftPayload')">📄 Left Payload</th>
                <th @click="sort('rightPayload')">📄 Right Payload</th>
                <th>🔗 Details</th>
                <th @click="sort('payloadTime')">⏰ Timestamp ↕</th>
            </tr>
            <tr v-if="!sortedResPayloads.length">
                <td colspan="4" class="empty-state">
                    <div class="empty-state-icon">📭</div>
                    <h3>No Payloads Found</h3>
                    <p>No payload data available for the selected time period</p>
                </td>
            </tr>
            <tr v-for="res in sortedResPayloads">
                <td>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <span style="flex: 1;">Left</span>
                        <input type="radio" :value="res.payload" :id="res.payloadKey + '_left'" v-model="leftPayload" v-on:change="doDiff();"/>
                    </label>
                </td>
                <td>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <span style="flex: 1;">Right</span>
                        <input type="radio" :value="res.payload" :id="res.payloadKey + '_right'" v-model="rightPayload" v-on:change="doDiff();"/>
                    </label>
                </td>
                <td><a :href ="res.origValue | get_payload_url" target="_blank">View Raw</a></td>
                <td>${ res.payloadTime | get_formatted_time}</td>
            </tr>
        </table>
        <div id="diffoutput"> </div>
    </div>

    <script>
    function diffUsingJS(leftText, rightText, viewType) {
        "use strict";
        var byId = function (id) {
                return document.getElementById(id);
            },
            base = difflib.stringAsLines(leftText),
            newtxt = difflib.stringAsLines(rightText),
            sm = new difflib.SequenceMatcher(base, newtxt),
            opcodes = sm.get_opcodes(),
            diffoutputdiv = byId("diffoutput"),
            contextSize = "";
        diffoutputdiv.innerHTML = "";
        contextSize = contextSize || null;

        diffoutputdiv.appendChild(diffview.buildView({
            baseTextLines: base,
            newTextLines: newtxt,
            opcodes: opcodes,
            baseTextName: "Left Payload",
            newTextName: "Right Payload",
            contextSize: contextSize,
            viewType: viewType
        }));
    }

    new Vue({
        el: '#resource_payload',
        delimiters: ['${', '}'],
        data: {
            resPayload: [],
            currentSortBy: 'payloadTime',
            currentSortDirection: 'asc',
            startTime: '',
            leftPayload: undefined,
            rightPayload: undefined,
            count: 0
        },
        filters: {
            get_formatted_time(unixnano_time) {
                return new Date(unixnano_time / 1000000).toISOString().split('T').join(' ');
            },
            get_payload_url(value) {
                return "debug/view?k=" + value.payloadKey;
            }
        },
        mounted() {
            NProgress.configure({
                easing: 'ease',
                minimum: 0.3,
                parent: '#resource_payload'
            });

            axios.interceptors.request.use(config => {
                NProgress.start();
                return config;
            });

            axios.interceptors.response.use(response => {
                NProgress.done();
                return response;
            });

            axios
                .get('{{.PayloadUrl}}')
                .then(response => {
                    if (response.data) {
                        this.resPayload = response.data.map(function (val) {
                            return {
                                payloadTime: val.payloadTime,
                                payloadKey: val.payloadKey,
                                payload: val.payload,
                                leftPayload:'',
                                rightPayload:'',
                                origValue: val,
                            };
                        });
                    } else {
                        console.log("No payloads found for period")
                    }
                })
        },
        methods: {
            sort: function (sortBy) {
                if (sortBy === this.currentSortBy) {
                    this.currentSortDirection = (this.currentSortDirection === 'asc') ? 'desc' : 'asc';
                }
                this.currentSortBy = sortBy;
            },
            pretty: function (value) {
                return JSON.stringify(JSON.parse(value), null, 2);
            },
            doDiff: function () {
                if (this.leftPayload != undefined && this.rightPayload != undefined) {
                    diffUsingJS(this.pretty(this.leftPayload), this.pretty(this.rightPayload), 1);
                }
            }
        },
        computed: {
            sortedResPayloads: function () {
                return this.resPayload.sort((a, b) => {
                    let direction = (this.currentSortDirection === 'asc') ? 1 : -1;
                    if (a[this.currentSortBy] < b[this.currentSortBy]) return -1 * direction;
                    if (a[this.currentSortBy] > b[this.currentSortBy]) return direction;
                    return 0;
                });
            }
        }
    });
</script>

<div id="resource_events" class="resource-section">
    <h2><span class="section-icon">📋</span> Events</h2>
    <table id="resource_event_table">
        <tr v-if="sortedResEvents.length">
            <th>🔗 Details</th>
            <th @click="sort('message')">💬 Message ↕</th>
            <th @click="sort('reason')">⚠️ Reason ↕</th>
            <th @click="sort('source')">🖥️ Source ↕</th>
            <th @click="sort('count')">🔢 Count ↕</th>
            <th @click="sort('firstSeen')">⏰ First Seen ↕</th>
            <th @click="sort('lastSeen')">⏰ Last Seen ↕</th>
        </tr>
        <tr v-if="!sortedResEvents.length">
            <td colspan="7" class="empty-state">
                <div class="empty-state-icon">📭</div>
                <h3>No Events Found</h3>
                <p>No events recorded for the selected time period</p>
            </td>
        </tr>
        <tr v-for="resEvent in sortedResEvents">
            <td><a :href="resEvent.origValue | get_payload_url" target="_blank">View Raw</a></td>
            <td>${ resEvent.message }</td>
            <td>${ resEvent.reason }</td>
            <td>${ resEvent.source }</td>
            <td>${ resEvent.count }</td>
            <td>${ resEvent.firstSeen | get_formatted_date }</td>
            <td>${ resEvent.lastSeen | get_formatted_date }</td>
        </tr>
    </table>
</div>

<script>
    new Vue({
        el: '#resource_events',
        delimiters: ['${', '}'],
        data: {
            resEvents: [],
            currentSortBy: 'firstSeen',
            currentSortDirection: 'asc'
        },
        filters: {
            get_formatted_date(value) {
                return value.split('T').join(' ');
            },
            get_payload_url(value) {
                return "debug/view?k=" + value.eventKey;
            }
        },
        mounted() {
            NProgress.configure({
                easing: 'ease',
                minimum: 0.3,
                parent: '#resource_events'
            });

            axios.interceptors.request.use(config => {
                NProgress.start();
                return config;
            });

            axios.interceptors.response.use(response => {
                NProgress.done();
                return response;
            });

            axios
                .get('{{.EventsUrl}}')
                .then(response => {
                    if (response.data) {
                        this.resEvents = response.data.map(function (val) {
                            let parsedVal = JSON.parse(val.payload);
                            return {
                                message: parsedVal.message,
                                source: parsedVal.source.host,
                                reason: parsedVal.reason,
                                count: parsedVal.count,
                                firstSeen: parsedVal.firstTimestamp,
                                lastSeen: parsedVal.lastTimestamp,
                                origValue: val
                            };
                        });
                    } else {
                        console.log("No events found for period")
                    }
                })
        },
        methods: {
            sort: function (sortBy) {
                if (sortBy === this.currentSortBy) {
                    this.currentSortDirection = (this.currentSortDirection === 'asc') ? 'desc' : 'asc';
                }
                this.currentSortBy = sortBy;
            }
        },
        computed: {
            sortedResEvents: function () {
                return this.resEvents.sort((a, b) => {
                    let direction = (this.currentSortDirection === 'asc') ? 1 : -1;
                    if (a[this.currentSortBy] < b[this.currentSortBy]) return -1 * direction;
                    if (a[this.currentSortBy] > b[this.currentSortBy]) return direction;
                    return 0;
                });
            }
        }
    });
</script>
</div>
</body>
</html>
